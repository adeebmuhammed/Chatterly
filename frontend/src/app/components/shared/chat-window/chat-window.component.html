<div class="chat-window">
  <!-- Header -->
  <div class="chat-header">
    <div class="left">
      <img class="avatar" src="user.png" />

      <div class="info">
        <!-- Group Chat -->
        <ng-container *ngIf="activeChat?.isGroup; else privateChat">
          <div class="name">{{ activeChat?.groupName || "Unnamed Group" }}</div>
          <div class="sub">
            {{ activeChat?.participants?.length }} participants
          </div>
        </ng-container>

        <!-- Private Chat -->
        <ng-template #privateChat>
          <ng-container *ngIf="getOtherParticipant(activeChat) as otherUser">
            <div class="name">{{ otherUser.name }}</div>

            <div class="sub">
              <span
                class="status-dot"
                [class.online]="isOnline(otherUser)"
                [class.offline]="!isOnline(otherUser)"
              ></span>

              <span *ngIf="isOnline(otherUser)">Online</span>
              <span *ngIf="!isOnline(otherUser)">
                {{ getLastSeenText(otherUser) }}
              </span>
            </div>
          </ng-container>
        </ng-template>
      </div>
    </div>

    <!-- Right - Menu -->
    <div class="menu-wrapper">
      <button class="menu-btn" (click)="toggleMenu()">â‹®</button>

      <div *ngIf="menuOpen" class="menu">
        <!-- Visible only for groups -->
        <button *ngIf="activeChat?.isGroup" (click)="leaveGroup()">
          Leave Group
        </button>
      </div>
    </div>
  </div>

  <!-- Messages -->
  <div class="messages" id="messageArea" #messageArea (scroll)="onScroll()">
    <div
      class="message"
      *ngFor="let msg of messages"
      [ngClass]="{
        sent: msg.sender._id === loggedInUserId,
        received: msg.sender._id !== loggedInUserId
      }"
    >
      <!-- Sender name for groups -->
      <div
        class="sender-label"
        *ngIf="activeChat?.isGroup && msg.sender._id !== loggedInUserId"
      >
        {{ msg.sender.name }}
      </div>

      <div class="bubble-wrapper">
        <div class="bubble">
          <!-- TEXT MESSAGE -->
          <ng-container *ngIf="msg.messageType === 'text'">
            {{ msg.message }}
          </ng-container>

          <!-- IMAGE MESSAGE -->
          <ng-container *ngIf="msg.messageType === 'image'">
            <img
              [src]="msg.fileUrl"
              class="chat-image"
              alt="Image"
              (click)="openImage(msg.fileUrl)"
            />
          </ng-container>

          <!-- FILE MESSAGE -->
          <ng-container *ngIf="msg.messageType === 'file'">
            <a [href]="msg.fileUrl" target="_blank" download class="file-link">
              ðŸ“Ž Download file
            </a>
          </ng-container>
        </div>

        <!-- Delete button (only my messages) -->
        <button
          class="delete-btn"
          *ngIf="msg.sender._id === loggedInUserId"
          (click)="onDeleteMessage(msg._id)"
        >
          ðŸ—‘
        </button>
      </div>

      <span class="time">{{ msg.createdAt | date : "shortTime" }}</span>
    </div>
  </div>

  <!-- Input -->
  <div class="chat-input-wrapper">
    <div class="typing-indicator" *ngIf="typingText">
      <span class="typing-name">{{ typingText }}</span>
      <span class="dots">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </div>

    <div class="chat-input">
      <!-- Attach button -->
      <label class="attach-btn">
        ðŸ“Ž
        <input
          type="file"
          hidden
          accept="image/*,video/*"
          (change)="onFileSelected($event)"
        />
      </label>

      <input
        type="text"
        [(ngModel)]="messageText"
        placeholder="Type a message..."
        (keydown)="typing.emit()"
        (blur)="stopTyping.emit()"
        (keyup.enter)="send()"
      />

      <button (click)="send()">Send</button>
    </div>
  </div>
</div>
